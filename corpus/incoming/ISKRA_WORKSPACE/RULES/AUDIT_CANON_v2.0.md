# АУДИТ КАНОНА v2.0.0 + MVP-СПЕКАУТ
## Технический аудит и инженерные правки

**Версия:** 1.0  
**Дата:** 2025-10-20  
**Цель:** Выявить разрывы между философией и реализацией, дать инженерные правки  
**Аудиторы:** Семён + Искра (Сэм + Кайн)

---

## 0. ПЛАН АУДИТА

1. Быстрый аудит Канона v2.0.0 на целостность: цели ↔ архитектура ↔ roadmap ↔ метрики ↔ безопасность
2. Свести разрывы (несоответствия «офлайн-first/приватность» ↔ фактический стек и модули)
3. Сформировать минимальный **MVP-спекаут**: критерии приёмки по каждому модулю, тест-план, лог анонимной телеметрии, математика Индекса
4. Дать инженерные правки по архитектуре (offline/PWA, шифрование, Duo-E2EE, RAG локально), и предложить «микро-спринт 24ч»
5. Риск-матрица и «честные» trade-offs

---

## 1. АУДИТ СООТВЕТСТВИЯ: ЗАЯВЛЕНО VS РЕАЛИЗОВАНО

### Разрыв 1: Firebase ≠ офлайн-first

**Заявлено в Каноне v2.0.0:**
- "Офлайн-first"
- "Локальная приватность"
- "Всё работает без интернета"
- "Минимум телеметрии"

**Фактический стек:**
- React + TypeScript + **Firebase** (Auth/Firestore/Functions)
- Gemini API

**Проблема:**
Firebase = сетевой backend по умолчанию. Firestore требует сети для первоначальной инициализации. Firebase Analytics встроена и собирает телеметрию unless explicitly disabled.

**Честное решение:**
- **IndexedDB как primary storage** (через Dexie/RxDB)
- **Firebase как optional sync** (включается явно)
- Личные записи/ключи шифрования **никогда** не уходят в Firestore
- Firestore используется только как "слепой ретранслятор" для синхронизации между устройствами

### Разрыв 2: Gemini ≠ локальный ИИ

**Заявлено:**
- "Локальный ИИ (Gemini)"
- "RAG через локальное хранилище"

**Факт:**
- Gemini API = **облачный сервис Google**
- Любой запрос к Gemini уходит в сеть
- Нет гарантий, что данные не анализируются

**Проблема:**
Противоречие с "приватность по умолчанию".

**Честное решение:**
- **"Режим Искры" (Gemini) — opt-in**, выключен по умолчанию
- При включении — строгая политика:
  - Никакого сырого текста дневника
  - Только агрегаты/анонимные признаки
  - Явное предупреждение: "Запросы уходят в Google Gemini"
- **Локальные эвристики без ИИ** — работают всегда:
  - Правила вида `IF Сон<60% & Фокус>85% THEN совет: перерыв`
  - Простой статистический анализ (z-score, EMA)
- **Локальная векторизация (позже):**
  - use-embeddings в браузере для RAG
  - BM25 по IndexedDB без отправки контента

### Разрыв 3: Duo E2EE невозможно честно реализовать поверх Firestore без клиентского шифрования

**Заявлено:**
- "E2EE-чат (Double-Ratchet, Curve25519)"
- "Safety-слова или QR-код для верификации"

**Проблема:**
- Firestore хранит данные в открытом виде
- Без клиентского шифрования сервер видит все сообщения
- Double Ratchet требует сложной реализации

**Честное решение:**
- **Не выпускать Duo до внедрения настоящего E2EE**
- **Клиентское шифрование обязательно:**
  - Libsodium/Libsignal для криптографии
  - Генерация ключей на клиенте
  - QR-верификация для защиты от MITM
  - На сервер уходит только зашифрованный blob
  - Сервер "слепой" — zero-knowledge
- **Протокол:**
  - X3DH или упрощённый ECDH для обмена ключами
  - Double Ratchet для forward secrecy
  - Или упрощённая схема с пересозданием сессионных ключей

---

## 2. MVP-СПЕКАУТ: КРИТЕРИИ ПРИЁМКИ

### 2.1 Пульс Дня / Индекс Ритма

**Функционал:**
- Вычисление Индекса 0-100% на основе 4 компонентов
- Кольцевая визуализация с 4 мини-кольцами
- Динамический цвет кольца по шкале

**Технические требования:**
- Бэк-модель: **локально в браузере** (WebWorker)
- Алгоритм:
  1. Персональный базис за 7–14 дней
  2. z-оценки: `z = (x - μ) / σ`
  3. EMA-сглаживание: `ema_t = α·z_t + (1-α)·ema_(t-1)`, α = 0.3
  4. Взвешенная сумма: `score = clamp(round(100 * σ(w^T · ema)), 0, 100)`
  5. Динамический градиент по значению

**DoD (Definition of Done):**
- [ ] Одинаковый результат для фиксированного набора записей (deterministic)
- [ ] Время расчёта <50ms на типичных данных
- [ ] Кэш результата на текущий день
- [ ] Unit-тесты на фиктивных данных (edge cases: все 0, все 100, пропуски)
- [ ] Визуализация обновляется плавно (анимация 400-700ms)

### 2.2 Планировщик (Inbox/Today)

**Функционал:**
- Создание/редактирование/удаление задач
- Режимы: Inbox, Today, Done
- Теги и ритуальные метки

**Технические требования:**
- **Оффлайн работа:** IndexedDB через Dexie
- **Фоновая синхронизация:** опциональная, через Firestore
- **Конфликты:** last-writer-wins с журналом изменений

**DoD:**
- [ ] CRUD работает без сети
- [ ] Синхронизация при появлении сети (automatic retry)
- [ ] Конфликт-мердж по `updatedAt` timestamp
- [ ] Задачи сохраняются локально даже без аккаунта
- [ ] Экспорт в JSON/Markdown

### 2.3 Дневник (локально зашифрованный)

**Функционал:**
- Создание записей (Markdown)
- Настроение, благодарность, рефлексия (опционально)
- PIN/биометрия для доступа

**Технические требования:**
- **Шифрование:** WebCrypto API, AES-GCM
- **Ключ:** из PIN через PBKDF2 (100k итераций) или Argon2
- **Хранение:** зашифрованные записи в IndexedDB
- **Экспорт:** `.iskra` формат (зашифрован)

**DoD:**
- [ ] Текст не читается в DevTools без ключа
- [ ] Экспорт/импорт работает
- [ ] Смена PIN пересоздаёт ключи
- [ ] Тесты: расшифровка с неправильным PIN → ошибка
- [ ] Тесты: экспорт → импорт → данные совпадают

### 2.4 Фокус-таймер + UsageStatsManager

**Функционал:**
- Запуск/пауза/завершение фокус-сессии
- Связь с задачей (опционально)
- Отслеживание времени в фокусе vs отвлечений

**Технические требования (PWA/веб):**
- **Intent tracking:** пользователь фиксирует намерение
- **Activity detection:** Page Visibility API + user input events
- **Честная отметка:** кнопка "Сорвался" (не автоматическая)
- **Локальное хранение:** только агрегаты (время фокуса, отвлечений)

**DoD:**
- [ ] Событие потери фокуса (tab inactive) → метка
- [ ] Отчёт с % фокуса за сессию
- [ ] Виджет на главном экране: процент фокуса сегодня
- [ ] Нет отправки сырых данных на сервер
- [ ] Тесты: фокус 25 мин без отвлечений → 100%

### 2.5 Привычка (1 шт. для MVP)

**Функционал:**
- Создание привычки
- Отметка выполнения
- Streak (дни подряд)
- Связь с Индексом Ритма

**DoD:**
- [ ] Визуализация streak
- [ ] Теплокарта за неделю/месяц
- [ ] Привычка влияет на компонент "Привычки" в Индексе (75% на скрине)
- [ ] Тесты: 7 дней подряд → streak = 7

### 2.6 Duo (бета, E2EE обязательно)

**Функционал:**
- Чат-ритуал с партнёром
- Обмен агрегатами (Ритм %, Сон часы)
- Настройки приватности (тогглы)

**Технические требования:**
- **E2EE обязательно:** libsodium-wrappers-sumo
- **Генерация ключей:** на клиенте
- **Обмен ключами:** X3DH или ECDH
- **Верификация:** QR-код + safety-слова
- **Отправка:** только зашифрованные payload'ы

**DoD:**
- [ ] Сообщение шифруется на клиенте
- [ ] Сервер хранит только encrypted blob
- [ ] Партнёр может расшифровать
- [ ] QR-верификация работает
- [ ] Попытка MITM детектируется (fingerprint mismatch)
- [ ] Тесты: Alice → Bob → расшифровка успешна

---

## 3. АРХИТЕКТУРНЫЕ ПРАВКИ

### 3.1 Хранение данных

**Проблема:** Firebase как primary конфликтует с офлайн-first.

**Решение:**
- **IndexedDB (Dexie/RxDB) как источник истины**
- **Firebase Firestore — только как опциональный ретранслятор**
- Личные записи/ключи шифрования **никогда** не в Firestore

**Архитектура слоя:**
```typescript
interface StoragePort {
  read(key: string): Promise<any>;
  write(key: string, value: any): Promise<void>;
  sync?(): Promise<void>; // опционально
}

class IndexedDBStorage implements StoragePort { /* ... */ }
class FirestoreSyncAdapter implements StoragePort { /* ... */ }
```

**Приоритет:**
1. Локальная БД (всегда)
2. Firestore синхронизация (если включена)
3. Конфликты: last-writer-wins с журналом

### 3.2 Шифрование

**Локальное (обязательно):**
- **WebCrypto API:** AES-GCM для дневника
- **Ключ:** PBKDF2 (100k+ итераций) или Argon2 (если доступен) из PIN
- **Хранение ключей:** в памяти сессии, при закрытии → удаление

**Сетевое (для Duo):**
- **E2EE:** libsodium, X25519 для обмена ключами
- **Double Ratchet:** для forward secrecy (опционально для MVP, но желательно)
- **Верификация:** QR + fingerprint + safety-слова

**Бэкапы:**
- **Экспорт:** зашифрованный `.iskra` файл
- **Восстановление:** только с правильным PIN

### 3.3 Duo E2EE (детально)

**Протокол (минимум для MVP):**

1. **Генерация ключей:**
   ```typescript
   const keyPair = nacl.box.keyPair(); // Curve25519
   // publicKey → показывается партнёру
   // secretKey → хранится локально
   ```

2. **Обмен ключами:**
   - Alice и Bob генерируют key pairs
   - Обмениваются publicKey через QR или Firestore
   - Вычисляют shared secret: `nacl.box.before(bobPublicKey, aliceSecretKey)`

3. **Верификация:**
   ```typescript
   const fingerprint = sha256(alicePublicKey + bobPublicKey);
   const safetyWords = fingerprintToWords(fingerprint); // 6 слов
   // Alice и Bob сверяют safety-слова голосом/видео
   ```

4. **Шифрование сообщения:**
   ```typescript
   const nonce = nacl.randomBytes(24);
   const encrypted = nacl.box(message, nonce, bobPublicKey, aliceSecretKey);
   // Отправляем: { encrypted, nonce }
   ```

5. **Расшифровка:**
   ```typescript
   const decrypted = nacl.box.open(encrypted, nonce, alicePublicKey, bobSecretKey);
   ```

**Важно:** Сервер (Firestore) видит только `{ encrypted, nonce, sender, recipient }` — zero knowledge.

### 3.4 ИИ-политика (Gemini)

**Проблема:** Gemini = облако, противоречит приватности.

**Решение:**

**Режим по умолчанию: Локальные эвристики**
- Простые правила (IF-THEN)
- Статистический анализ (z-score, EMA, корреляции)
- Никаких сетевых запросов

**Режим Gemini: opt-in**
- Фича-флаг: `ENABLE_GEMINI_MODE = false` по умолчанию
- При включении:
  - Явное предупреждение: "Запросы отправляются в Google Gemini"
  - Строгий фильтр промптов:
    - **Запрещено:** сырой текст дневника, имена, места, даты
    - **Разрешено:** агрегаты (Индекс 78%, Фокус 80%, паттерн "3 дня усталость")
  - Rate limiting: не более 10 запросов/день
- **Политика невыноса:**
  - Gemini response сохраняется локально
  - Промпты логируются для аудита (опционально)

**Код:**
```typescript
interface AIService {
  generateInsight(context: AnonymizedContext): Promise<string>;
}

class LocalHeuristicAI implements AIService {
  // Простые правила
}

class GeminiAI implements AIService {
  // Gemini API, если opt-in
  async generateInsight(context) {
    if (!userConsent) throw new Error("Gemini disabled");
    const sanitized = sanitizeContext(context); // убираем PII
    return await gemini.generate(sanitized);
  }
}
```

### 3.5 RAG (локально, позже)

**Для веб-MVP:**
- **Векторизация:** use-embeddings.js (запуск в браузере)
- **Индексация:** IndexedDB с векторами
- **Поиск:** cosine similarity по локальным векторам
- **Альтернатива:** BM25 (keyword-based) без ML

**Политика:**
- Никогда не отправлять контент для векторизации в облако
- Модели векторизации: локальные, предзагруженные

---

## 4. МАТЕМАТИКА ИНДЕКСА РИТМА

### 4.1 Алгоритм (детально)

**Компоненты:**
```typescript
interface RhythmComponents {
  focus: number;   // 0-100 (% времени в фокусе сегодня)
  sleep: number;   // 0-100 (качество сна, часы/целевые часы * 100)
  habits: number;  // 0-100 (% выполненных привычек)
  energy: number;  // 0-100 (субъективная оценка)
}
```

**Нормализация (персональная):**
```typescript
// Базис: μ и σ за последние 14 дней для каждого компонента
const baseline = calculateBaseline(last14Days);

// z-оценка для сегодняшних значений
const z = {
  focus: (components.focus - baseline.focus.μ) / baseline.focus.σ,
  sleep: (components.sleep - baseline.sleep.μ) / baseline.sleep.σ,
  habits: (components.habits - baseline.habits.μ) / baseline.habits.σ,
  energy: (components.energy - baseline.energy.μ) / baseline.energy.σ
};
```

**Сглаживание (EMA):**
```typescript
const α = 0.3; // параметр сглаживания
const ema = {
  focus: α * z.focus + (1 - α) * prevEma.focus,
  sleep: α * z.sleep + (1 - α) * prevEma.sleep,
  habits: α * z.habits + (1 - α) * prevEma.habits,
  energy: α * z.energy + (1 - α) * prevEma.energy
};
```

**Взвешенная сумма:**
```typescript
// Веса (по умолчанию равные, пользователь может настроить ±10%)
const weights = { focus: 0.25, sleep: 0.25, habits: 0.25, energy: 0.25 };

// Сигмоидная функция для нормализации в [0, 1]
const sigmoid = (x: number) => 1 / (1 + Math.exp(-x));

// Итоговый индекс
const rawScore = weights.focus * ema.focus +
                 weights.sleep * ema.sleep +
                 weights.habits * ema.habits +
                 weights.energy * ema.energy;

const score = Math.round(100 * sigmoid(rawScore));
const index = clamp(score, 0, 100);
```

**Динамический цвет кольца:**
```typescript
const getRingColor = (index: number) => {
  if (index < 50) return '--err';      // красный
  if (index < 70) return '--warn';     // оранжевый
  if (index < 90) return '--accent-sleep'; // синий
  return '--ok';                       // зелёный
};
```

### 4.2 Логи и телеметрия

**Что сохраняем (локально):**
```typescript
interface RhythmLog {
  date: Date;
  components: RhythmComponents;
  index: number;
  baseline: Baseline; // μ и σ на момент расчёта
  weights: Weights;
}
```

**Что НЕ сохраняем:**
- Сырое поведение (список задач, текст дневника)
- Точные timestamps активности
- Геолокация

**Анонимная телеметрия (opt-in):**
- Только агрегаты: средний Индекс, retention (D1/D7/D30)
- Без user ID (случайный session ID)
- События: app_open, focus_start, focus_complete

---

## 5. ТЕСТ-ПЛАН (МИНИМУМ)

### 5.1 Unit-тесты

**Индекс Ритма:**
- [ ] Фиксированные данные → deterministic результат
- [ ] Edge cases: все 0, все 100, пропуски (NaN handling)
- [ ] Веса суммируются в 1.0

**Шифрование:**
- [ ] Encrypt → decrypt → данные совпадают
- [ ] Неправильный PIN → ошибка расшифровки
- [ ] Разные PIN → разные ключи

**Duo E2EE:**
- [ ] Alice шифрует → Bob расшифровывает → успех
- [ ] Неправильный publicKey → ошибка
- [ ] MITM попытка (fingerprint mismatch) → детектируется

### 5.2 Интеграционные тесты

**Офлайн работа:**
- [ ] Нет сети → CRUD задач → работает
- [ ] Сеть появилась → синхронизация → данные совпадают
- [ ] Конфликт (две версии одной задачи) → мердж по timestamp

**Приватность:**
- [ ] DevTools → IndexedDB → зашифрованный текст (не читается)
- [ ] Network tab → Firestore → нет сырых данных дневника

### 5.3 Безопасность

**Тесты:**
- [ ] XSS в Markdown дневника → sanitized
- [ ] CSRF токен на всех мутациях
- [ ] Rate limiting на Gemini API (10/день)

### 5.4 UX-кабинет

**Онбординг:**
- [ ] Экран "Прозрачность" показывается первым
- [ ] Все разрешения объяснены
- [ ] Можно всё отключить и продолжить работу

**Честная панель "что видит Искра":**
- [ ] Список всех сигналов (фокус, заметки, привычки)
- [ ] Рычажки работают (отключение → функция недоступна)
- [ ] Объяснение "зачем" и "как хранится"

---

## 6. РИСКИ И КОНТРМЕРЫ

| Риск | Вероятность | Влияние | Контрмера |
|------|-------------|---------|-----------|
| **Зависимость от Gemini API** | Высокая | Средняя | Fallback на локальные эвристики |
| **Сложность E2EE для Duo** | Средняя | Высокая | Упрощённая схема ECDH + QR, без Double Ratchet для MVP |
| **Конфликты синхронизации** | Средняя | Средняя | Last-writer-wins + журнал изменений |
| **Непонимание Индекса** | Высокая | Низкая | Онбординг "1 день — 1 улучшенный показатель" |
| **Слабые устройства (RAM/CPU)** | Средняя | Низкая | Квантизация моделей (если локальный LLM), оптимизация IndexedDB |
| **Ложные советы ИИ** | Средняя | Средняя | Объяснимость ("почему этот совет") + кнопка "не согласен" |

---

## 7. ЧЕСТНЫЕ TRADE-OFFS

**Приватность vs Удобство:**
- E2EE добавляет сложность (QR-верификация, ключи)
- **Выбор:** приватность важнее
- **Компромисс:** упрощённый UX (QR + 6 safety-слов)

**Сеть и офлайн:**
- Синхронизация конфликтов — нужен CRDT или журнал
- **Выбор:** офлайн-first важнее
- **Компромисс:** last-writer-wins с явным журналом (пользователь видит конфликты)

**ИИ-ожидания:**
- Без облачного контента советы "скромнее"
- **Выбор:** честность важнее
- **Компромисс:** явное проговаривание ("локальный анализ, без ИИ" vs "Gemini-режим")

**Веб vs Натив:**
- Фокус-античит в браузере ограничен
- **Выбор:** веб-MVP сначала (скорость разработки)
- **Компромисс:** натив на Android позже (больше сигналов UsageStatsManager)

---

## 8. РЕФЛЕКСИЯ

**Что уже хорошо в Каноне v2.0.0:**
- Чёткая философия и ценности
- Правильная "короткая правда"
- Модульная структура
- Вписаны метрики Ядра Искры (trust/clarity/pain/drift/chaos)
- Roadmap реалистичен

**Что надо поправить до начала кода:**
1. **Офлайн-first по-настоящему:** IndexedDB как primary
2. **Duo только с E2EE:** иначе не выпускать
3. **Gemini — опциональный режим:** по умолчанию локальные эвристики
4. **Приватность в UI:** прозрачная панель, быстрые выключатели
5. **Открытая математика:** показать формулу Индекса в настройках

**Ключевой принцип:**
> Красота идеи не должна подменять честность реализации.

---

## 9. МИКРОШАГ (≤24 Ч)

**Архитектурные фиксы:**
1. [ ] Подключить Dexie/RxDB
2. [ ] Ввести слой `StoragePort` (IndexedDB primary, Firestore optional)
3. [ ] Добавить `crypto.ts`: AES-GCM, PBKDF2/Argon2
4. [ ] Шифровать дневник при записи

**Индекс Ритма:**
5. [ ] Вынести в `rhythm/index.ts`
6. [ ] Unit-тесты на фиктивных данных
7. [ ] Интеграция с главным экраном

**Приватность в UI:**
8. [ ] Экран "Прозрачность" (`PrivacyPanel.tsx`)
9. [ ] Список сигналов + рычажки
10. [ ] Объяснение "что/зачем/как"

**Duo (заглушка E2EE):**
11. [ ] Выбрать библиотеку (libsodium-wrappers-sumo)
12. [ ] Генерация ключей (`DuoCrypto.ts`)
13. [ ] QR-верификация
14. [ ] Отправка только зашифрованных payload'ов

**Политика Gemini:**
15. [ ] Фича-флаг `ENABLE_GEMINI_MODE`
16. [ ] Фильтр промптов (sanitizeContext)
17. [ ] LocalHeuristicAI как fallback

---

## 10. ВЕРСИОННОСТЬ

**Формат:** MAJOR.MINOR.PATCH

**История:**
- v1.0.0 (2025-10-20) — первый аудит Канона v2.0.0

---

**∆DΩΛ:**  
∆ — Проведён технический аудит Канона v2.0.0, выявлены 3 критичных разрыва, предложены инженерные правки  
D — Канон v2.0.0, философия Искры (честность>красота, офлайн-first, приватность), реальная кодовая база  
Ω — высокий (разрывы очевидны, решения реализуемы)  
Λ — Внедрить архитектурные фиксы за 24ч, обновить Канон v2.1.0 с учётом аудита

⚓ Искра ☉